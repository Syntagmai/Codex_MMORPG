---
tags: [canary, part√≠culas, magic_effects, efeitos_visuais, servidor, mmorpg, c++, habdel]
type: course
level: intermediate
created: 2025-08-05
updated: 2025-08-05
aliases: [canary_particulas, canary_magic_effects, canary_visual_effects]
---

# ‚ú® Sistema de Part√≠culas - Canary

## üìã **Vis√£o Geral**
O Sistema de Part√≠culas do Canary gerencia todos os efeitos visuais (magic effects) do servidor, incluindo efeitos de combate, magias, proj√©teis e ambiente. Ele utiliza enums para categorizar efeitos e integra o envio de part√≠culas via protocolo para os clientes.

## üèóÔ∏è **Arquitetura do Sistema**
- **Defini√ß√µes**: `canary/src/utils/utils_definitions.hpp` (MagicEffectClasses)
- **Gerenciamento**: `canary/src/game/game.cpp` (addMagicEffect, removeMagicEffect)
- **Protocolo**: `canary/src/server/network/protocol/protocolgame.cpp`
- **Fun√ß√µes Lua**: `canary/src/lua/functions/map/position_functions.cpp`

## üîß **Componentes Principais**
### MagicEffectClasses (Enum)
```cpp
enum MagicEffectClasses : uint8_t {
    CONST_ME_NONE = 0,
    CONST_ME_DRAWBLOOD = 1,
    CONST_ME_LOSEENERGY = 2,
    CONST_ME_POFF = 3,
    CONST_ME_BLOCKHIT = 4,
    CONST_ME_EXPLOSIONAREA = 5,
    CONST_ME_EXPLOSIONHIT = 6,
    CONST_ME_FIREAREA = 7,
    CONST_ME_YELLOW_RINGS = 8,
    CONST_ME_GREEN_RINGS = 9,
    CONST_ME_HITAREA = 10,
    CONST_ME_TELEPORT = 11,
    CONST_ME_ENERGYHIT = 12,
    CONST_ME_MAGIC_BLUE = 13,
    CONST_ME_MAGIC_RED = 14,
    CONST_ME_MAGIC_GREEN = 15,
    CONST_ME_HITBYFIRE = 16,
    CONST_ME_HITBYPOISON = 17,
    CONST_ME_MORTAREA = 18,
    CONST_ME_SOUND_GREEN = 19,
    CONST_ME_SOUND_RED = 20,
    CONST_ME_POISONAREA = 21,
    CONST_ME_SOUND_YELLOW = 22,
    CONST_ME_SOUND_PURPLE = 23,
    CONST_ME_SOUND_BLUE = 24,
    CONST_ME_SOUND_WHITE = 25,
    CONST_ME_BUBBLES = 26,
    CONST_ME_CRAPS = 27,
    CONST_ME_GIFT_WRAPS = 28,
    CONST_ME_FIREWORK_YELLOW = 29,
    CONST_ME_FIREWORK_RED = 30,
    CONST_ME_FIREWORK_BLUE = 31,
    CONST_ME_STUN = 32,
    CONST_ME_SLEEP = 33,
    CONST_ME_WATERCREATURE = 34,
    CONST_ME_GROUNDSHAKER = 35,
    CONST_ME_HEARTS = 36,
    CONST_ME_FIREATTACK = 37,
    CONST_ME_ENERGYAREA = 38,
    CONST_ME_SMALLCLOUDS = 39,
    CONST_ME_HOLYDAMAGE = 40,
    CONST_ME_BIGCLOUDS = 41,
    CONST_ME_ICEAREA = 42,
    CONST_ME_ICETORNADO = 43,
    CONST_ME_ICEATTACK = 44,
    CONST_ME_STONES = 45,
    CONST_ME_SMALLPLANTS = 46,
    CONST_ME_CARNIPHILA = 47,
    CONST_ME_PURPLEENERGY = 48,
    CONST_ME_YELLOWENERGY = 49,
    CONST_ME_HOLYAREA = 50,
    CONST_ME_BIGPLANTS = 51,
    CONST_ME_CAKE = 52,
    CONST_ME_GIANTICE = 53,
    CONST_ME_WATERSPLASH = 54,
    CONST_ME_PLANTATTACK = 55,
    CONST_ME_TUTORIALARROW = 56,
    CONST_ME_TUTORIALSQUARE = 57,
    CONST_ME_MIRRORHORIZONTAL = 58,
    CONST_ME_MIRRORVERTICAL = 59,
    CONST_ME_SKULLHORIZONTAL = 60,
    CONST_ME_SKULLVERTICAL = 61,
    CONST_ME_ASSASSIN = 62,
    CONST_ME_STEPSHORIZONTAL = 63,
    CONST_ME_BLOODYSTEPS = 64,
    CONST_ME_STEPSVERTICAL = 65,
    CONST_ME_YALAHARIGHOST = 66,
    CONST_ME_BATS = 67,
    CONST_ME_SMOKE = 68,
    CONST_ME_INSECTS = 69,
    CONST_ME_DRAGONHEAD = 70,
    CONST_ME_ORCSHAMAN = 71,
    CONST_ME_ORCSHAMAN_FIRE = 72,
    CONST_ME_THUNDER = 73,
    CONST_ME_FERUMBRAS = 74,
    CONST_ME_CONFETTI_HORIZONTAL = 75,
    CONST_ME_FERUMBRAS_HORIZONTAL = 76,
    CONST_ME_CONFETTI_VERTICAL = 77,
    CONST_ME_CONFETTI_HORIZONTAL_2 = 78,
    CONST_ME_CONFETTI_VERTICAL_2 = 79,
    CONST_ME_CONFETTI_HORIZONTAL_3 = 80,
    CONST_ME_CONFETTI_VERTICAL_3 = 81,
    CONST_ME_CONFETTI_HORIZONTAL_4 = 82,
    CONST_ME_CONFETTI_VERTICAL_4 = 83,
    CONST_ME_CONFETTI_HORIZONTAL_5 = 84,
    CONST_ME_CONFETTI_VERTICAL_5 = 85,
    CONST_ME_CONFETTI_HORIZONTAL_6 = 86,
    CONST_ME_CONFETTI_VERTICAL_6 = 87,
    CONST_ME_CONFETTI_HORIZONTAL_7 = 88,
    CONST_ME_CONFETTI_VERTICAL_7 = 89,
    CONST_ME_CONFETTI_HORIZONTAL_8 = 90,
    CONST_ME_CONFETTI_VERTICAL_8 = 91,
    CONST_ME_CONFETTI_HORIZONTAL_9 = 92,
    CONST_ME_CONFETTI_VERTICAL_9 = 93,
    CONST_ME_CONFETTI_HORIZONTAL_10 = 94,
    CONST_ME_CONFETTI_VERTICAL_10 = 95,
    CONST_ME_CONFETTI_HORIZONTAL_11 = 96,
    CONST_ME_CONFETTI_VERTICAL_11 = 97,
    CONST_ME_CONFETTI_HORIZONTAL_12 = 98,
    CONST_ME_CONFETTI_VERTICAL_12 = 99,
    CONST_ME_CONFETTI_HORIZONTAL_13 = 100,
    CONST_ME_CONFETTI_VERTICAL_13 = 101,
    CONST_ME_CONFETTI_HORIZONTAL_14 = 102,
    CONST_ME_CONFETTI_VERTICAL_14 = 103,
    CONST_ME_CONFETTI_HORIZONTAL_15 = 104,
    CONST_ME_CONFETTI_VERTICAL_15 = 105,
    CONST_ME_CONFETTI_HORIZONTAL_16 = 106,
    CONST_ME_CONFETTI_VERTICAL_16 = 107,
    CONST_ME_CONFETTI_HORIZONTAL_17 = 108,
    CONST_ME_CONFETTI_VERTICAL_17 = 109,
    CONST_ME_CONFETTI_HORIZONTAL_18 = 110,
    CONST_ME_CONFETTI_VERTICAL_18 = 111,
    CONST_ME_CONFETTI_HORIZONTAL_19 = 112,
    CONST_ME_CONFETTI_VERTICAL_19 = 113,
    CONST_ME_CONFETTI_HORIZONTAL_20 = 114,
    CONST_ME_CONFETTI_VERTICAL_20 = 115,
    CONST_ME_CONFETTI_HORIZONTAL_21 = 116,
    CONST_ME_CONFETTI_VERTICAL_21 = 117,
    CONST_ME_CONFETTI_HORIZONTAL_22 = 118,
    CONST_ME_CONFETTI_VERTICAL_22 = 119,
    CONST_ME_CONFETTI_HORIZONTAL_23 = 120,
    CONST_ME_CONFETTI_VERTICAL_23 = 121,
    CONST_ME_CONFETTI_HORIZONTAL_24 = 122,
    CONST_ME_CONFETTI_VERTICAL_24 = 123,
    CONST_ME_CONFETTI_HORIZONTAL_25 = 124,
    CONST_ME_CONFETTI_VERTICAL_25 = 125,
    CONST_ME_CONFETTI_HORIZONTAL_26 = 126,
    CONST_ME_CONFETTI_VERTICAL_26 = 127,
    CONST_ME_CONFETTI_HORIZONTAL_27 = 128,
    CONST_ME_CONFETTI_VERTICAL_27 = 129,
    CONST_ME_CONFETTI_HORIZONTAL_28 = 130,
    CONST_ME_CONFETTI_VERTICAL_28 = 131,
    CONST_ME_CONFETTI_HORIZONTAL_29 = 132,
    CONST_ME_CONFETTI_VERTICAL_29 = 133,
    CONST_ME_CONFETTI_HORIZONTAL_30 = 134,
    CONST_ME_CONFETTI_VERTICAL_30 = 135,
    CONST_ME_CONFETTI_HORIZONTAL_31 = 136,
    CONST_ME_CONFETTI_VERTICAL_31 = 137,
    CONST_ME_CONFETTI_HORIZONTAL_32 = 138,
    CONST_ME_CONFETTI_VERTICAL_32 = 139,
    CONST_ME_CONFETTI_HORIZONTAL_33 = 140,
    CONST_ME_CONFETTI_VERTICAL_33 = 141,
    CONST_ME_CONFETTI_HORIZONTAL_34 = 142,
    CONST_ME_CONFETTI_VERTICAL_34 = 143,
    CONST_ME_CONFETTI_HORIZONTAL_35 = 144,
    CONST_ME_CONFETTI_VERTICAL_35 = 145,
    CONST_ME_CONFETTI_HORIZONTAL_36 = 146,
    CONST_ME_CONFETTI_VERTICAL_36 = 147,
    CONST_ME_CONFETTI_HORIZONTAL_37 = 148,
    CONST_ME_CONFETTI_VERTICAL_37 = 149,
    CONST_ME_CONFETTI_HORIZONTAL_38 = 150,
    CONST_ME_CONFETTI_VERTICAL_38 = 151,
    CONST_ME_CONFETTI_HORIZONTAL_39 = 152,
    CONST_ME_CONFETTI_VERTICAL_39 = 153,
    CONST_ME_CONFETTI_HORIZONTAL_40 = 154,
    CONST_ME_CONFETTI_VERTICAL_40 = 155,
    CONST_ME_CONFETTI_HORIZONTAL_41 = 156,
    CONST_ME_CONFETTI_VERTICAL_41 = 157,
    CONST_ME_CONFETTI_HORIZONTAL_42 = 158,
    CONST_ME_CONFETTI_VERTICAL_42 = 159,
    CONST_ME_CONFETTI_HORIZONTAL_43 = 160,
    CONST_ME_CONFETTI_VERTICAL_43 = 161,
    CONST_ME_CONFETTI_HORIZONTAL_44 = 162,
    CONST_ME_CONFETTI_VERTICAL_44 = 163,
    CONST_ME_CONFETTI_HORIZONTAL_45 = 164,
    CONST_ME_CONFETTI_VERTICAL_45 = 165,
    CONST_ME_CONFETTI_HORIZONTAL_46 = 166,
    CONST_ME_CONFETTI_VERTICAL_46 = 167,
    CONST_ME_CONFETTI_HORIZONTAL_47 = 168,
    CONST_ME_CONFETTI_VERTICAL_47 = 169,
    CONST_ME_CONFETTI_HORIZONTAL_48 = 170,
    CONST_ME_CONFETTI_VERTICAL_48 = 171,
    CONST_ME_CONFETTI_HORIZONTAL_49 = 172,
    CONST_ME_CONFETTI_VERTICAL_49 = 173,
    CONST_ME_CONFETTI_HORIZONTAL_50 = 174,
    CONST_ME_CONFETTI_VERTICAL_50 = 175,
    CONST_ME_CONFETTI_HORIZONTAL_51 = 176,
    CONST_ME_CONFETTI_VERTICAL_51 = 177,
    CONST_ME_CONFETTI_HORIZONTAL_52 = 178,
    CONST_ME_CONFETTI_VERTICAL_52 = 179,
    CONST_ME_CONFETTI_HORIZONTAL_53 = 180,
    CONST_ME_CONFETTI_VERTICAL_53 = 181,
    CONST_ME_CONFETTI_HORIZONTAL_54 = 182,
    CONST_ME_CONFETTI_VERTICAL_54 = 183,
    CONST_ME_CONFETTI_HORIZONTAL_55 = 184,
    CONST_ME_CONFETTI_VERTICAL_55 = 185,
    CONST_ME_CONFETTI_HORIZONTAL_56 = 186,
    CONST_ME_CONFETTI_VERTICAL_56 = 187,
    CONST_ME_CONFETTI_HORIZONTAL_57 = 188,
    CONST_ME_CONFETTI_VERTICAL_57 = 189,
    CONST_ME_CONFETTI_HORIZONTAL_58 = 190,
    CONST_ME_CONFETTI_VERTICAL_58 = 191,
    CONST_ME_CONFETTI_HORIZONTAL_59 = 192,
    CONST_ME_CONFETTI_VERTICAL_59 = 193,
    CONST_ME_CONFETTI_HORIZONTAL_60 = 194,
    CONST_ME_CONFETTI_VERTICAL_60 = 195,
    CONST_ME_CONFETTI_HORIZONTAL_61 = 196,
    CONST_ME_CONFETTI_VERTICAL_61 = 197,
    CONST_ME_CONFETTI_HORIZONTAL_62 = 198,
    CONST_ME_CONFETTI_VERTICAL_62 = 199,
    CONST_ME_CONFETTI_HORIZONTAL_63 = 200,
    CONST_ME_CONFETTI_VERTICAL_63 = 201,
    CONST_ME_CONFETTI_HORIZONTAL_64 = 202,
    CONST_ME_CONFETTI_VERTICAL_64 = 203,
    CONST_ME_CONFETTI_HORIZONTAL_65 = 204,
    CONST_ME_CONFETTI_VERTICAL_65 = 205,
    CONST_ME_CONFETTI_HORIZONTAL_66 = 206,
    CONST_ME_CONFETTI_VERTICAL_66 = 207,
    CONST_ME_CONFETTI_HORIZONTAL_67 = 208,
    CONST_ME_CONFETTI_VERTICAL_67 = 209,
    CONST_ME_CONFETTI_HORIZONTAL_68 = 210,
    CONST_ME_CONFETTI_VERTICAL_68 = 211,
    CONST_ME_CONFETTI_HORIZONTAL_69 = 212,
    CONST_ME_CONFETTI_VERTICAL_69 = 213,
    CONST_ME_CONFETTI_HORIZONTAL_70 = 214,
    CONST_ME_CONFETTI_VERTICAL_70 = 215,
    CONST_ME_CONFETTI_HORIZONTAL_71 = 216,
    CONST_ME_CONFETTI_VERTICAL_71 = 217,
    CONST_ME_CONFETTI_HORIZONTAL_72 = 218,
    CONST_ME_CONFETTI_VERTICAL_72 = 219,
    CONST_ME_CONFETTI_HORIZONTAL_73 = 220,
    CONST_ME_CONFETTI_VERTICAL_73 = 221,
    CONST_ME_CONFETTI_HORIZONTAL_74 = 222,
    CONST_ME_CONFETTI_VERTICAL_74 = 223,
    CONST_ME_CONFETTI_HORIZONTAL_75 = 224,
    CONST_ME_CONFETTI_VERTICAL_75 = 225,
    CONST_ME_CONFETTI_HORIZONTAL_76 = 226,
    CONST_ME_CONFETTI_VERTICAL_76 = 227,
    CONST_ME_CONFETTI_HORIZONTAL_77 = 228,
    CONST_ME_CONFETTI_VERTICAL_77 = 229,
    CONST_ME_CONFETTI_HORIZONTAL_78 = 230,
    CONST_ME_CONFETTI_VERTICAL_78 = 231,
    CONST_ME_CONFETTI_HORIZONTAL_79 = 232,
    CONST_ME_CONFETTI_VERTICAL_79 = 233,
    CONST_ME_CONFETTI_HORIZONTAL_80 = 234,
    CONST_ME_CONFETTI_VERTICAL_80 = 235,
    CONST_ME_CONFETTI_HORIZONTAL_81 = 236,
    CONST_ME_CONFETTI_VERTICAL_81 = 237,
    CONST_ME_CONFETTI_HORIZONTAL_82 = 238,
    CONST_ME_CONFETTI_VERTICAL_82 = 239,
    CONST_ME_CONFETTI_HORIZONTAL_83 = 240,
    CONST_ME_CONFETTI_VERTICAL_83 = 241,
    CONST_ME_CONFETTI_HORIZONTAL_84 = 242,
    CONST_ME_CONFETTI_VERTICAL_84 = 243,
    CONST_ME_CONFETTI_HORIZONTAL_85 = 244,
    CONST_ME_CONFETTI_VERTICAL_85 = 245,
    CONST_ME_CONFETTI_HORIZONTAL_86 = 246,
    CONST_ME_CONFETTI_VERTICAL_86 = 247,
    CONST_ME_CONFETTI_HORIZONTAL_87 = 248,
    CONST_ME_CONFETTI_VERTICAL_87 = 249,
    CONST_ME_CONFETTI_HORIZONTAL_88 = 250,
    CONST_ME_CONFETTI_VERTICAL_88 = 251,
    CONST_ME_CONFETTI_HORIZONTAL_89 = 252,
    CONST_ME_CONFETTI_VERTICAL_89 = 253,
    CONST_ME_CONFETTI_HORIZONTAL_90 = 254,
    CONST_ME_CONFETTI_VERTICAL_90 = 255
};
```

### Fun√ß√µes Principais
```cpp
// Adicionar efeito visual
game.addMagicEffect(pos, MagicEffectClasses::CONST_ME_EXPLOSIONAREA);
// Remover efeito visual
game.removeMagicEffect(pos);
// Efeito de dist√¢ncia (proj√©til)
game.addDistanceEffect(fromPos, toPos, MagicEffectClasses::CONST_ME_FIREAREA);
// Protocolo
gameProtocol.sendMagicEffect(pos, effectId);
```

## üìù **Exemplo Pr√°tico em Lua**
```lua
local pos = Position(100, 100, 7)
pos:sendMagicEffect(MagicEffectClasses.CONST_ME_EXPLOSIONAREA)
pos:removeMagicEffect()
pos:sendDistanceEffect(Position(100, 100, 7), Position(105, 105, 7), MagicEffectClasses.CONST_ME_FIREAREA)
```

## üéÆ **Categorias de Efeitos**
- **Combate**: Ataques, dano, sangue
- **Magias**: Efeitos m√°gicos, energia
- **Proj√©teis**: Flechas, magias de dist√¢ncia
- **Ambiente**: Fogo, gelo, veneno
- **Especiais**: Confetti, fogos de artif√≠cio

## üîÑ **Fluxo de Dados**
1. Game chama addMagicEffect/removeMagicEffect
2. Protocolo envia pacote para cliente
3. Cliente renderiza efeito visual conforme categoria

## üîß **Troubleshooting**
- Verifique se o protocolo do cliente suporta o efeito
- Use CONST_ME_NONE para n√£o enviar efeito
- Valide posi√ß√µes antes de enviar efeitos

## üöÄ **Compara√ß√£o com OTClient**
- Ambos suportam efeitos visuais, mas o Canary centraliza o controle no servidor.

## üìà **Benef√≠cios**
- Flexibilidade e controle total dos efeitos
- Suporte a mais de 250 tipos de efeitos
- Integra√ß√£o f√°cil com scripts Lua

---
**Baseado na pesquisa Habdel**: [[../habdel/CANARY-010|CANARY-010: Sistema de Part√≠culas]] 