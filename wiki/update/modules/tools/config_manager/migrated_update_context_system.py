# Constantes
MAX_RETRIES = 8
MAX_ATTEMPTS = 10
TIMEOUT_SECONDS = 60

#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Script Migrado: update_context_system.py
M√≥dulo de Destino: tools.config_manager
Data de Migra√ß√£o: 2025-08-01 12:21:35

Script original migrado para a estrutura modular unificada.
"""

# Imports do m√≥dulo
from . import ConfigmanagerModule

# Conte√∫do original do script
#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Script de Atualiza√ß√£o do Sistema de Contexto e Navega√ß√£o
Atualiza automaticamente os mapas de contexto e navega√ß√£o inteligente
"""

import json

class ContextSystemUpdater:
    def __init__(self):
        self.base_path = Path(".")
        self.maps_path = Path("wiki/maps")
        self.rules_path = Path(".cursor/rules")
        self.wiki_path = Path("wiki")
        
    def update_enhanced_context_system(self):
        """Atualiza o sistema de contexto avan√ßado"""
        print("üîÑ Atualizando sistema de contexto avan√ßado...")
        
        # Verificar estrutura atual
        structure = self.analyze_directory_structure()
        
        # Atualizar contexto
        context_data = {
            "context_system": {
                "version": "2.0",
                "last_updated": datetime.now().isoformat(),
                "repository_info": {
                    "name": "otclient_doc",
                    "type": "otclient",
                    "description": "Documenta√ß√£o e sistema de regras do OTClient",
                    "main_focus": "client_side_development",
                    "integration_target": "canary_server"
                },
                # Estrutura de diret√≥rios atualizada para subm√≥dulos
                "directory_structure": {
                    "root": {
                        "path": "/",
                        "description": "Raiz do reposit√≥rio principal (BMAD Agent)",
                        "permissions": "full_access",
                        "key_files": [
                            "cursor.md",
                            ".gitmodules",
                            "README.md"
                        ]
                    },
                    "otclient_submodule": {
                        "path": "otclient/",
                        "description": "Subm√≥dulo OTClient (imut√°vel, fonte de verdade)",
                        "permissions": "read_only"
                    },
                    "canary_submodule": {
                        "path": "canary/",
                        "description": "Subm√≥dulo Canary (imut√°vel, fonte de verdade)",
                        "permissions": "read_only"
                    },
                    "wiki": {
                        "path": "wiki/",
                        "description": "Documenta√ß√£o e automa√ß√£o (edit√°vel)",
                        "permissions": "full_access",
                        "subdirectories": {
                            "bmad": "Documenta√ß√£o bmad",
                            "integration": "Documenta√ß√£o de integra√ß√£o",
                            "otclient": "Documenta√ß√£o OTClient",
                            "canary": "Documenta√ß√£o Canary",
                            "maps": "Mapas de navega√ß√£o"
                        }
                    },
                    "cursor_rules": {
                        "path": ".cursor/rules/",
                        "description": "Sistema de regras do assistente",
                        "permissions": "full_access",
                        "total_rules": 25
                    }
                },
                "navigation_system": self.get_navigation_system(),
                "performance_optimization": self.get_performance_config(),
                "context_detection": self.get_context_detection(),
                "integration_status": self.get_integration_status()
            }
        }
        
        # Salvar arquivo
        output_file = self.maps_path / "enhanced_context_system.json"
        with open(output_file, 'w', encoding='utf-8') as f:
            json.dump(context_data, f, indent=2, ensure_ascii=False)
        
        print(f"‚úÖ Sistema de contexto atualizado: {output_file}")
        return context_data
    
    def update_intelligent_navigation(self):
        """Atualiza o sistema de navega√ß√£o inteligente"""
        print("üß≠ Atualizando sistema de navega√ß√£o inteligente...")
        
        navigation_data = {
            "intelligent_navigation": {
                "version": "1.0",
                "last_updated": datetime.now().isoformat(),
                "navigation_patterns": self.get_navigation_patterns(),
                "smart_caching": self.get_smart_caching(),
                "performance_metrics": self.get_performance_metrics(),
                "context_switching": self.get_context_switching(),
                "error_recovery": self.get_error_recovery()
            }
        }
        
        # Salvar arquivo
        output_file = self.maps_path / "intelligent_navigation.json"
        with open(output_file, 'w', encoding='utf-8') as f:
            json.dump(navigation_data, f, indent=2, ensure_ascii=False)
        
        print(f"‚úÖ Navega√ß√£o inteligente atualizada: {output_file}")
        return navigation_data
    
    def analyze_directory_structure(self):
        """Analisa a estrutura de diret√≥rios atual"""
        structure = {
            "root": {
                "path": "/",
                "description": "Raiz do reposit√≥rio OTClient",
                "permissions": "read_only",
                "key_files": self.get_key_files(self.base_path)
            },
            "wiki": {
                "path": "wiki/",
                "description": "Documenta√ß√£o estruturada da wiki",
                "permissions": "full_access",
                "subdirectories": self.get_wiki_subdirectories()
            },
            "cursor_rules": {
                "path": ".cursor/rules/",
                "description": "Sistema de regras do assistente",
                "permissions": "full_access",
                "total_rules": len(list(self.rules_path.glob("*.md")))
            },
            "source_code": {
                "path": "src/",
                "description": "C√≥digo-fonte do OTClient",
                "permissions": "read_only",
                "key_components": self.get_source_components()
            },
            "modules": {
                "path": "modules/",
                "description": "M√≥dulos Lua do OTClient",
                "permissions": "read_only",
                "categories": self.get_module_categories()
            },
            "data": {
                "path": "data/",
                "description": "Recursos e dados do cliente",
                "permissions": "read_only",
                "categories": self.get_data_categories()
            }
        }
        
        return structure
    
    def get_key_files(self, path):
        """Obt√©m arquivos-chave de um diret√≥rio"""
        key_files = []
        for file in path.iterdir():
            if file.is_file() and file.name in ["README.md", "CMakeLists.txt", "cursor.md"]:
                key_files.append(file.name)
        return key_files
    
    def get_wiki_subdirectories(self):
        """Obt√©m subdiret√≥rios da wiki"""
        subdirs = {}
        if self.wiki_path.exists():
            for item in self.wiki_path.iterdir():
                if item.is_dir() and not item.name.startswith('.'):
                    subdirs[item.name] = f"Documenta√ß√£o {item.name}"
        return subdirs
    
    def get_source_components(self):
        """Obt√©m componentes do c√≥digo-fonte"""
        src_path = Path("src")
        components = []
        if src_path.exists():
            for item in src_path.iterdir():
                if item.is_dir():
                    components.append(f"{item.name}/")
        return components
    
    def get_module_categories(self):
        """Obt√©m categorias de m√≥dulos"""
        modules_path = Path("modules")
        categories = []
        if modules_path.exists():
            for item in modules_path.iterdir():
                if item.is_dir():
                    categories.append(item.name)
        return categories
    
    def get_data_categories(self):
        """Obt√©m categorias de dados"""
        data_path = Path("data")
        categories = []
        if data_path.exists():
            for item in data_path.iterdir():
                if item.is_dir():
                    categories.append(item.name)
        return categories
    
    def get_navigation_system(self):
        """Obt√©m configura√ß√£o do sistema de navega√ß√£o"""
        return {
            "primary_indexes": {
                "wiki_map": "wiki/maps/wiki_map.json",
                "tags_index": "wiki/maps/tags_index.json",
                "relationships": "wiki/maps/relationships.json",
                "source_index": "wiki/maps/otclient_source_index.json",
                "modules_index": "wiki/maps/modules_index.json",
                "resources_index": "wiki/maps/resources_index.json",
                "styles_index": "wiki/maps/styles_index.json",
                "tools_index": "wiki/maps/tools_index.json",
                "bmad_agents": "wiki/maps/bmad_agents_index.json",
                "bmad_workflows": "wiki/maps/bmad_workflows_index.json",
                "bmad_templates": "wiki/maps/bmad_templates_index.json",
                "habdel_index": "wiki/maps/habdel_index.json"
            },
            "context_rules": {
                "otclient_focus": {
                    "priority": "high",
                    "paths": ["src/client/", "modules/client_", "data/"],
                    "documentation": "wiki/otclient/",
                    "integration": "wiki/integration/"
                },
                "bmad_system": {
                    "priority": "medium",
                    "paths": ["wiki/bmad/", ".cursor/rules/"],
                    "documentation": "wiki/bmad/",
                    "agents": "wiki/maps/bmad_agents_index.json"
                },
                "integration_focus": {
                    "priority": "medium",
                    "paths": ["wiki/integration/"],
                    "documentation": "wiki/integration/",
                    "cross_project": True
                }
            },
            "quick_access": {
                "frequently_used": [
                    "cursor.md",
                    "wiki/otclient_wiki.md",
                    ".cursor/rules/rules.md",
                    "wiki/maps/tags_index.json"
                ],
                "context_switchers": [
                    "wiki/maps/context_data.json",
                    "wiki/maps/enhanced_context_system.json"
                ],
                "performance_monitors": [
                    "wiki/log/performance_metrics.json",
                    "wiki/log/system_status.json"
                ]
            }
        }
    
    def get_performance_config(self):
        """Obt√©m configura√ß√£o de performance"""
        return {
            "cache_strategy": {
                "file_structure": 300,
                "json_maps": 600,
                "context_data": 1800,
                "rule_references": 900
            },
            "search_limits": {
                "max_results": 50,
                "max_depth": 3,
                "max_file_reads": 10,
                "timeout_seconds": 30
            },
            "lazy_loading": {
                "enabled": True,
                "rules": True,
                "maps": True,
                "documentation": False
            }
        }
    
    def get_context_detection(self):
        """Obt√©m configura√ß√£o de detec√ß√£o de contexto"""
        return {
            "automatic": True,
            "indicators": {
                "otclient": ["otclient/", "canary/"],
                "canary": ["canary/"],
                "unified": ["wiki/otclient/", "wiki/canary/", "wiki/integration/"]
            },
            "fallback": "otclient"
        }
    
    def get_integration_status(self):
        """Obt√©m status de integra√ß√£o"""
        return {
            "otclient": "active",
            "canary": "planned",
            "unified": "in_progress",
            "bmad": "active"
        }
    
    def get_navigation_patterns(self):
        """Obt√©m padr√µes de navega√ß√£o"""
        return {
            "context_aware": {
                "otclient_development": {
                    "primary_paths": ["otclient/", "canary/"],
                    "documentation": "wiki/otclient/",
                    "rules": [".cursor/rules/otclient-source-index-rules.md"],
                    "quick_access": ["cursor.md", "wiki/maps/otclient_source_index.json"]
                },
                "bmad_system": {
                    "primary_paths": ["wiki/bmad/", ".cursor/rules/"],
                    "documentation": "wiki/bmad/",
                    "rules": [".cursor/rules/bmad-system-rules.md"],
                    "quick_access": ["wiki/maps/bmad_agents_index.json", "wiki/maps/bmad_workflows_index.json"]
                },
                "wiki_documentation": {
                    "primary_paths": ["wiki/"],
                    "documentation": "wiki/",
                    "rules": [".cursor/rules/wiki-rules.md", ".cursor/rules/wiki-comprehensive-rules.md"],
                    "quick_access": ["wiki/maps/tags_index.json", "wiki/maps/wiki_map.json"]
                },
                "integration_work": {
                    "primary_paths": ["wiki/integration/"],
                    "documentation": "wiki/integration/",
                    "rules": [".cursor/rules/cross-project-integration-rules.md"],
                    "quick_access": ["wiki/maps/relationships.json"]
                }
            },
            "task_based": {
                "code_analysis": {
                    "sequence": [
                        "wiki/maps/otclient_source_index.json",
                        "src/",
                        "modules/",
                        "wiki/otclient/"
                    ],
                    "priority": "high"
                },
                "documentation_search": {
                    "sequence": [
                        "wiki/maps/tags_index.json",
                        "wiki/maps/wiki_map.json",
                        "wiki/",
                        "wiki/maps/relationships.json"
                    ],
                    "priority": "high"
                },
                "rule_consultation": {
                    "sequence": [
                        "cursor.md",
                        ".cursor/rules/",
                        "wiki/maps/enhanced_context_system.json"
                    ],
                    "priority": "medium"
                },
                "bmad_workflow": {
                    "sequence": [
                        "wiki/maps/bmad_agents_index.json",
                        "wiki/maps/bmad_workflows_index.json",
                        "wiki/bmad/",
                        ".cursor/rules/bmad-system-rules.md"
                    ],
                    "priority": "medium"
                }
            }
        }
    
    def get_smart_caching(self):
        """Obt√©m configura√ß√£o de cache inteligente"""
        return {
            "file_access_patterns": {
                "frequently_accessed": {
                    "files": [
                        "cursor.md",
                        "wiki/maps/tags_index.json",
                        "wiki/maps/wiki_map.json",
                        ".cursor/rules/rules.md"
                    ],
                    "cache_duration": 1800,
                    "priority": "high"
                },
                "context_switchers": {
                    "files": [
                        "wiki/maps/enhanced_context_system.json",
                        "wiki/maps/context_data.json"
                    ],
                    "cache_duration": 900,
                    "priority": "medium"
                },
                "large_datasets": {
                    "files": [
                        "wiki/maps/otclient_source_index.json",
                        "wiki/maps/modules_index.json",
                        "wiki/maps/resources_index.json"
                    ],
                    "cache_duration": 3600,
                    "priority": "low"
                }
            },
            "search_optimization": {
                "indexed_searches": {
                    "tags": "wiki/maps/tags_index.json",
                    "relationships": "wiki/maps/relationships.json",
                    "source_code": "wiki/maps/otclient_source_index.json",
                    "modules": "wiki/maps/modules_index.json"
                },
                "full_text_searches": {
                    "documentation": "wiki/",
                    "rules": ".cursor/rules/",
                    "source": "src/"
                }
            }
        }
    
    def get_performance_metrics(self):
        """Obt√©m m√©tricas de performance"""
        return {
            "access_patterns": {
                "most_accessed_files": [
                    "cursor.md",
                    "wiki/maps/tags_index.json",
                    "wiki/maps/wiki_map.json",
                    ".cursor/rules/rules.md"
                ],
                "access_frequency": {
                    "high": ">10 times per session",
                    "medium": "3-10 times per session",
                    "low": "<3 times per session"
                }
            },
            "response_times": {
                "target": {
                    "simple_queries": "<2 seconds",
                    "complex_queries": "<10 seconds",
                    "large_datasets": "<30 seconds"
                },
                "current": {
                    "simple_queries": "~1.5 seconds",
                    "complex_queries": "~8 seconds",
                    "large_datasets": "~25 seconds"
                }
            }
        }
    
    def get_context_switching(self):
        """Obt√©m configura√ß√£o de troca de contexto"""
        return {
            "automatic_detection": {
                "triggers": [
                    "file_path_analysis",
                    "content_keywords",
                    "user_query_patterns"
                ],
                "confidence_threshold": 0.8
            },
            "manual_override": {
                "commands": [
                    "@otclient",
                    "@bmad",
                    "@wiki",
                    "@integration"
                ],
                "context_files": [
                    "wiki/maps/enhanced_context_system.json",
                    "wiki/maps/context_data.json"
                ]
            }
        }
    
    def get_error_recovery(self):
        """Obt√©m configura√ß√£o de recupera√ß√£o de erros"""
        return {
            "fallback_strategies": {
                "file_not_found": {
                    "action": "search_similar",
                    "fallback": "use_index"
                },
                "permission_denied": {
                    "action": "switch_context",
                    "fallback": "read_only_mode"
                },
                "timeout": {
                    "action": "reduce_scope",
                    "fallback": "simple_mode"
                }
            },
            "retry_logic": {
                "max_retries": 3,
                "backoff_strategy": "exponential",
                "timeout_increase": 1.5
            }
        }
    
    def generate_report(self):
        """Gera relat√≥rio de atualiza√ß√£o"""
        report = {
            "update_report": {
                "timestamp": datetime.now().isoformat(),
                "files_updated": [
                    "wiki/maps/enhanced_context_system.json",
                    "wiki/maps/intelligent_navigation.json"
                ],
                "performance_improvements": {
                    "cache_strategy": "Implementado cache inteligente",
                    "navigation_patterns": "Padr√µes de navega√ß√£o otimizados",
                    "context_detection": "Detec√ß√£o autom√°tica de contexto",
                    "error_recovery": "Sistema de recupera√ß√£o de erros"
                },
                "next_steps": [
                    "Monitorar performance do sistema",
                    "Ajustar configura√ß√µes conforme necess√°rio",
                    "Implementar m√©tricas de uso",
                    "Otimizar baseado em dados reais"
                ]
            }
        }
        
        # Salvar relat√≥rio
        report_file = self.maps_path / "context_update_report.json"
        with open(report_file, 'w', encoding='utf-8') as f:
            json.dump(report, f, indent=2, ensure_ascii=False)
        
        print(f"üìä Relat√≥rio gerado: {report_file}")
        return report

def main():
    """Fun√ß√£o principal"""
    print("üöÄ Iniciando atualiza√ß√£o do sistema de contexto e navega√ß√£o...")
    
    updater = ContextSystemUpdater()
    
    # Atualizar sistema de contexto
    context_data = updater.update_enhanced_context_system()
    
    # Atualizar navega√ß√£o inteligente
    navigation_data = updater.update_intelligent_navigation()
    
    # Gerar relat√≥rio
    report = updater.generate_report()
    
    print("‚úÖ Atualiza√ß√£o conclu√≠da com sucesso!")
    print("üìà Sistema de contexto e navega√ß√£o otimizado")
    print("üéØ Pr√≥ximo passo: Monitorar performance e ajustar conforme necess√°rio")

if __name__ == "__main__":
    main() 

# Fun√ß√£o de integra√ß√£o com o m√≥dulo
def integrate_with_module():
    """Integra o script com o m√≥dulo de destino."""
    module = ConfigmanagerModule()
    return module.execute()

if __name__ == "__main__":
    # Executar integra√ß√£o com m√≥dulo
    result = integrate_with_module()
    if result:
        print(f"‚úÖ Script update_context_system.py executado com sucesso via m√≥dulo tools.config_manager")
    else:
        print(f"‚ùå Erro na execu√ß√£o do script update_context_system.py via m√≥dulo tools.config_manager")
