---
tags: [otclient, modules, combat, inventory, npc, lua, game_systems, educational]
aliases: [sistema_modulos_otclient, modulos_jogo, combat_system, inventory_system, npc_system]
type: educational_module
level: intermediate
created: 2025-08-05
updated: 2025-08-05
dependencies: [3.1_introducao_otclient, 3.2_sistema_graficos, 3.3_interface_usuario, 3.4_comunicacao_rede]
---

# ğŸ® **MÃ³dulo 3.5: Sistema de MÃ³dulos - OTClient**

> [!info] **MÃ³dulo IntermediÃ¡rio**
> Este mÃ³dulo explora os sistemas de mÃ³dulos do OTClient, incluindo combate, inventÃ¡rio e NPCs, usando exemplos reais de cÃ³digo extraÃ­dos do cÃ³digo-fonte.

---

## ğŸ“š **ConteÃºdo do MÃ³dulo**

### **ğŸ¯ Objetivos de Aprendizado**
- Compreender a arquitetura modular do OTClient
- Implementar sistemas de combate com controles de batalha
- Gerenciar inventÃ¡rio e itens do jogador
- Criar interfaces de NPC e comÃ©rcio
- Integrar sistemas usando eventos e callbacks

### **ğŸ”— DependÃªncias**
- [[3.1_introducao_otclient|MÃ³dulo 3.1: IntroduÃ§Ã£o ao OTClient]]
- [[3.2_sistema_graficos|MÃ³dulo 3.2: Sistema de GrÃ¡ficos]]
- [[3.3_interface_usuario|MÃ³dulo 3.3: Interface do UsuÃ¡rio]]
- [[3.4_comunicacao_rede|MÃ³dulo 3.4: ComunicaÃ§Ã£o de Rede]]

---

## ğŸ—‚ï¸ **Estrutura dos MÃ³dulos OTClient**

### **ğŸ“ OrganizaÃ§Ã£o Modular**
O OTClient utiliza uma arquitetura modular onde cada funcionalidade Ã© implementada como um mÃ³dulo independente:

```lua
-- Estrutura tÃ­pica de um mÃ³dulo OTClient
-- Baseado em: otclient/modules/game_battle/battle.lua

local moduleName = "game_battle"
local battleWindow, battleButton, battlePanel
local battleButtons = {} -- map of creature id

-- Pool de objetos para otimizaÃ§Ã£o
local BattleButtonPool = ObjectPool.new(function()
    local widget = g_ui.createWidget('BattleButton')
    widget:show()
    widget:setOn(true)
    widget.onHoverChange = onBattleButtonHoverChange
    widget.onMouseRelease = onBattleButtonMouseRelease
    return widget
end, function(obj)
    battlePanel:removeChild(obj)
end)

function init()
    -- Carregamento do mÃ³dulo
    g_ui.importStyle('battlebutton')
    battleButton = modules.game_mainpanel.addToggleButton('battleButton', 
        tr('Battle') .. ' (Ctrl+B)', '/images/options/button_battlelist', toggle, false, 2)
    battleButton:setOn(true)
    battleWindow = g_ui.loadUI('battle')
    
    -- ConfiguraÃ§Ã£o de atalhos
    Keybind.new("Windows", "Show/hide battle list", "Ctrl+B", "")
    Keybind.bind("Windows", "Show/hide battle list", {
        { type = KEY_DOWN, callback = toggle }
    })
    
    -- ConfiguraÃ§Ã£o de componentes
    battlePanel = battleWindow:recursiveGetChildById('battlePanel')
    filterPanel = battleWindow:recursiveGetChildById('filterPanel')
end
```

---

## âš”ï¸ **Sistema de Combate**

### **ğŸ® Controles de Batalha**
O sistema de combate do OTClient gerencia ataques, posturas e modos de perseguiÃ§Ã£o:

```lua
-- Sistema de combate baseado em: otclient/modules/game_inventory/inventory.lua
local function combatEvent()
    if g_game.getChaseMode() == ChaseOpponent then
        selectPosture('follow', true)
    end
end

local function selectCombat(combat, chase)
    if combat == 'attack' then
        g_game.setFightMode(FightOffensive)
    elseif combat == 'balanced' then
        g_game.setFightMode(FightBalanced)
    elseif combat == 'defense' then
        g_game.setFightMode(FightDefensive)
    end
    
    if chase then
        g_game.setChaseMode(ChaseOpponent)
    else
        g_game.setChaseMode(DontChase)
    end
end

-- PersistÃªncia de configuraÃ§Ãµes de combate
local function saveCombatControls()
    local char = g_game.getCharacterName()
    local lastCombatControls = g_settings.getNode('LastCombatControls')
    if not lastCombatControls then
        lastCombatControls = {}
    end
    
    lastCombatControls[char] = {
        fightMode = g_game.getFightMode(),
        chaseMode = g_game.getChaseMode(),
        safeFight = g_game.isSafeFight(),
        pvpMode = g_game.getPVPMode()
    }
    
    g_settings.setNode('LastCombatControls', lastCombatControls)
end
```

### **ğŸ‘¥ Lista de Batalha**
Sistema para gerenciar criaturas visÃ­veis e interaÃ§Ãµes de combate:

```lua
-- Lista de batalha baseada em: otclient/modules/game_battle/battle.lua
local function onCreatureAppear(creature)
    if creature:isLocalPlayer() then return end
    
    local button = BattleButtonPool:get()
    button:setId('battle_' .. creature:getId())
    button.creature = creature
    
    -- Configurar informaÃ§Ãµes da criatura
    button:setText(creature:getName())
    button:setIcon(creature:getOutfit())
    
    -- Atualizar informaÃ§Ãµes de vida
    if creature:getHealthPercent() > 0 then
        button:setProgress(creature:getHealthPercent() / 100)
    end
    
    battleButtons[creature:getId()] = button
end

local function onCreatureDisappear(creature)
    local button = battleButtons[creature:getId()]
    if button then
        BattleButtonPool:put(button)
        battleButtons[creature:getId()] = nil
    end
end

local function onBattleButtonMouseRelease(widget, mousePos, mouseButton)
    if mouseButton == MouseLeftButton then
        local creature = widget.creature
        if creature then
            g_game.attack(creature)
        end
    end
end
```

---

## ğŸ’ **Sistema de InventÃ¡rio**

### **ğŸ“¦ Gerenciamento de Slots**
O sistema de inventÃ¡rio gerencia os slots de equipamento do jogador:

```lua
-- Sistema de inventÃ¡rio baseado em: otclient/modules/game_inventory/inventory.lua
local getSlotPanelBySlot = {
    [InventorySlotHead] = function(ui) return ui.helmet, ui.helmet.helmet end,
    [InventorySlotNeck] = function(ui) return ui.amulet, ui.amulet.amulet end,
    [InventorySlotBack] = function(ui) return ui.backpack, ui.backpack.backpack end,
    [InventorySlotBody] = function(ui) return ui.armor, ui.armor.armor end,
    [InventorySlotRight] = function(ui) return ui.shield, ui.shield.shield end,
    [InventorySlotLeft] = function(ui) return ui.sword, ui.sword.sword end,
    [InventorySlotLeg] = function(ui) return ui.legs, ui.legs.legs end,
    [InventorySlotFeet] = function(ui) return ui.boots, ui.boots.boots end,
    [InventorySlotFinger] = function(ui) return ui.ring, ui.ring.ring end,
    [InventorySlotAmmo] = function(ui) return ui.tools, ui.tools.tools end
}

local function updateSlotItem(slot, item)
    local ui = getInventoryUi()
    local getSlotInfo = getSlotPanelBySlot[slot]
    if getSlotInfo then
        local slotPanel, itemWidget = getSlotInfo(ui)
        if slotPanel then
            if item then
                itemWidget:setItem(item)
                itemWidget:show()
                
                -- Configurar duraÃ§Ã£o se aplicÃ¡vel
                if item:getDurationTime() > 0 then
                    itemSlotsWithDuration[slot] = {
                        item = item,
                        timeEnd = g_clock.seconds() + item:getDurationTime()
                    }
                end
            else
                itemWidget:clearItem()
                itemWidget:hide()
            end
        end
    end
end
```

### **â±ï¸ Sistema de DuraÃ§Ã£o**
Gerenciamento de itens com duraÃ§Ã£o limitada:

```lua
-- Sistema de duraÃ§Ã£o baseado em: otclient/modules/game_inventory/inventory.lua
local function formatDuration(duration)
    return string.format("%dm%02d", duration / 60, duration % 60)
end

local function updateSlotsDuration()
    if not g_game.isOnline() or next(itemSlotsWithDuration) == nil then
        stopEvent()
        return
    end
    
    local currTime = g_clock.seconds()
    local ui = getInventoryUi()
    local hasItemsWithDuration = false
    
    for slot, itemDurationReg in pairs(itemSlotsWithDuration) do
        local item = itemDurationReg.item
        if item and item:getDurationTime() > 0 then
            hasItemsWithDuration = true
            local durationTimeLeft = math.max(0, itemDurationReg.timeEnd - currTime)
            local getSlotInfo = getSlotPanelBySlot[slot]
            if getSlotInfo then
                local slotPanel = getSlotInfo(ui)
                if slotPanel and slotPanel.item then
                    slotPanel.item.duration:setText(formatDuration(durationTimeLeft))
                end
            end
        end
    end
    
    if hasItemsWithDuration then
        updateSlotsDurationEvent = scheduleEvent(updateSlotsDuration, DURATION_UPDATE_INTERVAL)
    else
        stopEvent()
    end
end
```

---

## ğŸ—£ï¸ **Sistema de NPCs**

### **ğŸª Interface de ComÃ©rcio**
Sistema para interaÃ§Ã£o com NPCs e comÃ©rcio:

```lua
-- Sistema de NPC baseado em: otclient/modules/game_npctrade/npctrade.lua
BUY = 1
SELL = 2
CURRENCY = 'gold'
WEIGHT_UNIT = 'oz'

local npcWindow = nil
local itemsPanel = nil
local tradeItems = {}
local playerItems = {}
local selectedItem = nil

function init()
    npcWindow = g_ui.displayUI('npctrade')
    npcWindow:setVisible(false)
    
    itemsPanel = npcWindow:recursiveGetChildById('itemsPanel')
    searchText = npcWindow:recursiveGetChildById('searchText')
    
    -- Configurar painÃ©is de interface
    setupPanel = npcWindow:recursiveGetChildById('setupPanel')
    quantityScroll = setupPanel:getChildById('quantityScroll')
    nameLabel = setupPanel:getChildById('name')
    priceLabel = setupPanel:getChildById('price')
    moneyLabel = setupPanel:getChildById('money')
    
    -- Configurar opÃ§Ãµes de comÃ©rcio
    buyWithBackpack = npcWindow:recursiveGetChildById('buyWithBackpack')
    ignoreCapacity = npcWindow:recursiveGetChildById('ignoreCapacity')
    ignoreEquipped = npcWindow:recursiveGetChildById('ignoreEquipped')
    
    -- Conectar eventos
    connect(g_game, {
        onGameEnd = hide,
        onOpenNpcTrade = onOpenNpcTrade,
        onCloseNpcTrade = onCloseNpcTrade,
        onPlayerGoods = onPlayerGoods
    })
    
    connect(LocalPlayer, {
        onFreeCapacityChange = onFreeCapacityChange,
        onInventoryChange = onInventoryChange
    })
end
```

### **ğŸ’° Gerenciamento de TransaÃ§Ãµes**
Sistema para compra e venda de itens:

```lua
-- Sistema de transaÃ§Ãµes baseado em: otclient/modules/game_npctrade/npctrade.lua
local function onOpenNpcTrade(npc, tradeItems, playerItems)
    npcWindow:show()
    npcWindow:focus()
    
    -- Configurar itens disponÃ­veis para compra
    tradeItems[BUY] = {}
    for key, item in pairs(tradeItems) do
        if item[4] > 0 then -- PreÃ§o de compra
            local newItem = {
                ptr = item[1],
                name = item[2],
                weight = item[3] / 100,
                price = item[4]
            }
            table.insert(tradeItems[BUY], newItem)
        end
    end
    
    -- Configurar itens do jogador para venda
    tradeItems[SELL] = {}
    for key, item in pairs(tradeItems) do
        if item[5] > 0 then -- PreÃ§o de venda
            local newItem = {
                ptr = item[1],
                name = item[2],
                weight = item[3] / 100,
                price = item[5]
            }
            table.insert(tradeItems[SELL], newItem)
        end
    end
    
    refreshTradeItems()
end

local function onPlayerGoods(money, items)
    playerMoney = money
    moneyLabel:setText(formatCurrency(money))
    
    playerItems = {}
    for key, item in pairs(items) do
        local id = item[1]:getId()
        if not playerItems[id] then
            playerItems[id] = item[2]
        else
            playerItems[id] = playerItems[id] + item[2]
        end
    end
    
    refreshPlayerItems()
end

local function buyItem(item, amount)
    if not selectedItem then return end
    
    local quantity = amount or quantityScroll:getValue()
    if quantity > 0 then
        g_game.buyItem(selectedItem.ptr, quantity, ignoreCapacity:isChecked(), buyWithBackpack:isChecked())
    end
end
```

---

## ğŸ”§ **IntegraÃ§Ã£o de Sistemas**

### **ğŸ¯ Eventos e Callbacks**
Como os sistemas se comunicam atravÃ©s de eventos:

```lua
-- IntegraÃ§Ã£o de sistemas baseada em: otclient/modules/game_battle/battle.lua
local function connecting()
    connect(LocalPlayer, {
        onPositionChange = onCreaturePositionChange
    })
    
    connect(Creature, {
        onSkullChange = updateCreatureSkull,
        onEmblemChange = updateCreatureEmblem,
        onOutfitChange = onCreatureOutfitChange,
        onHealthPercentChange = onCreatureHealthPercentChange,
        onPositionChange = onCreaturePositionChange,
        onAppear = onCreatureAppear,
        onDisappear = onCreatureDisappear
    })
    
    connect(UIMap, {
        onZoomChange = onZoomChange
    })
    
    checkCreatures()
    return true
end

local function disconnecting(gameEvent)
    disconnect(LocalPlayer, {
        onPositionChange = onCreaturePositionChange
    })
    
    disconnect(Creature, {
        onSkullChange = updateCreatureSkull,
        onEmblemChange = updateCreatureEmblem,
        onOutfitChange = onCreatureOutfitChange,
        onHealthPercentChange = onCreatureHealthPercentChange,
        onPositionChange = onCreaturePositionChange,
        onAppear = onCreatureAppear,
        onDisappear = onCreatureDisappear
    })
    
    disconnect(UIMap, {
        onZoomChange = onZoomChange
    })
    
    return true
end
```

### **ğŸ”„ Pool de Objetos**
OtimizaÃ§Ã£o de performance usando pools de objetos:

```lua
-- Pool de objetos baseado em: otclient/modules/game_battle/battle.lua
local BattleButtonPool = ObjectPool.new(function()
    local widget = g_ui.createWidget('BattleButton')
    widget:show()
    widget:setOn(true)
    widget.onHoverChange = onBattleButtonHoverChange
    widget.onMouseRelease = onBattleButtonMouseRelease
    return widget
end, function(obj)
    battlePanel:removeChild(obj)
end)

-- Uso do pool
local function createBattleButton(creature)
    local button = BattleButtonPool:get()
    button.creature = creature
    button:setText(creature:getName())
    return button
end

local function destroyBattleButton(creatureId)
    local button = battleButtons[creatureId]
    if button then
        BattleButtonPool:put(button)
        battleButtons[creatureId] = nil
    end
end
```

---

## ğŸ¯ **ExercÃ­cios PrÃ¡ticos**

### **ğŸ“ ExercÃ­cio 1: Sistema de Combate BÃ¡sico**
Crie um mÃ³dulo de combate que implemente:
- Controles de modo de luta (ofensivo, equilibrado, defensivo)
- Sistema de perseguiÃ§Ã£o automÃ¡tica
- Lista de criaturas visÃ­veis
- Atalhos de teclado para aÃ§Ãµes de combate

**CÃ³digo Base:**
```lua
-- Implemente baseado nos exemplos do battle.lua
local combatModule = {
    name = "custom_combat",
    window = nil,
    button = nil
}

function combatModule:init()
    -- Implementar inicializaÃ§Ã£o
end

function combatModule:toggle()
    -- Implementar toggle da janela
end
```

### **ğŸ“ ExercÃ­cio 2: Sistema de InventÃ¡rio AvanÃ§ado**
Desenvolva um sistema de inventÃ¡rio que inclua:
- Gerenciamento de slots de equipamento
- Sistema de duraÃ§Ã£o de itens
- Filtros por tipo de item
- Sistema de busca e organizaÃ§Ã£o

**CÃ³digo Base:**
```lua
-- Implemente baseado nos exemplos do inventory.lua
local inventoryModule = {
    name = "custom_inventory",
    slots = {},
    itemsWithDuration = {}
}

function inventoryModule:updateSlot(slot, item)
    -- Implementar atualizaÃ§Ã£o de slot
end

function inventoryModule:updateDurations()
    -- Implementar sistema de duraÃ§Ã£o
end
```

### **ğŸ“ ExercÃ­cio 3: Interface de NPC Completa**
Crie uma interface de NPC que suporte:
- Sistema de compra e venda
- Gerenciamento de moeda
- VerificaÃ§Ã£o de capacidade
- Sistema de busca de itens

**CÃ³digo Base:**
```lua
-- Implemente baseado nos exemplos do npctrade.lua
local npcModule = {
    name = "custom_npc",
    window = nil,
    tradeItems = {},
    playerItems = {}
}

function npcModule:openTrade(npc, items)
    -- Implementar abertura de comÃ©rcio
end

function npcModule:buyItem(item, amount)
    -- Implementar compra de item
end
```

---

## ğŸš€ **Projeto PrÃ¡tico: Sistema de MÃ³dulos Integrado**

### **ğŸ¯ Objetivo**
Criar um sistema modular completo que integre combate, inventÃ¡rio e NPCs em uma interface unificada.

### **ğŸ“‹ Requisitos**
1. **MÃ³dulo de Combate**:
   - Lista de criaturas com informaÃ§Ãµes de vida
   - Controles de modo de luta
   - Sistema de atalhos de teclado

2. **MÃ³dulo de InventÃ¡rio**:
   - VisualizaÃ§Ã£o de slots de equipamento
   - Sistema de duraÃ§Ã£o de itens
   - Filtros e busca

3. **MÃ³dulo de NPC**:
   - Interface de comÃ©rcio
   - Gerenciamento de transaÃ§Ãµes
   - Sistema de moeda

4. **IntegraÃ§Ã£o**:
   - ComunicaÃ§Ã£o entre mÃ³dulos
   - Sistema de eventos unificado
   - Interface de usuÃ¡rio consistente

### **ğŸ”§ ImplementaÃ§Ã£o**
```lua
-- Sistema modular integrado
local IntegratedModuleSystem = {
    modules = {},
    events = {},
    ui = {}
}

function IntegratedModuleSystem:registerModule(name, module)
    self.modules[name] = module
    module:init()
end

function IntegratedModuleSystem:createMainWindow()
    self.ui.mainWindow = g_ui.createWidget('MainWindow', rootWidget)
    self.ui.tabBar = g_ui.createWidget('TabBar', self.ui.mainWindow)
    
    -- Adicionar abas para cada mÃ³dulo
    self.ui.tabBar:addTab('Combat', function() self:showCombatTab() end)
    self.ui.tabBar:addTab('Inventory', function() self:showInventoryTab() end)
    self.ui.tabBar:addTab('NPC', function() self:showNPCTab() end)
end

function IntegratedModuleSystem:showCombatTab()
    -- Implementar aba de combate
end

function IntegratedModuleSystem:showInventoryTab()
    -- Implementar aba de inventÃ¡rio
end

function IntegratedModuleSystem:showNPCTab()
    -- Implementar aba de NPC
end
```

---

## ğŸ“š **Recursos Adicionais**

### **ğŸ”— Links Relacionados**
- [[3.1_introducao_otclient|MÃ³dulo 3.1: IntroduÃ§Ã£o ao OTClient]]
- [[3.2_sistema_graficos|MÃ³dulo 3.2: Sistema de GrÃ¡ficos]]
- [[3.3_interface_usuario|MÃ³dulo 3.3: Interface do UsuÃ¡rio]]
- [[3.4_comunicacao_rede|MÃ³dulo 3.4: ComunicaÃ§Ã£o de Rede]]
- [[3.6_integracao_lua|MÃ³dulo 3.6: IntegraÃ§Ã£o Lua]]

### **ğŸ“– DocumentaÃ§Ã£o TÃ©cnica**
- [OTClient Battle System](../../otclient/modules/game_battle/)
- [OTClient Inventory System](../../otclient/modules/game_inventory/)
- [OTClient NPC Trade System](../../otclient/modules/game_npctrade/)

### **ğŸ“ PrÃ³ximos Passos**
- [[3.6_integracao_lua|MÃ³dulo 3.6: IntegraÃ§Ã£o Lua]]
- [[3.7_sistemas_jogo|MÃ³dulo 3.7: Sistemas de Jogo]]
- [[3.8_otimizacao_performance|MÃ³dulo 3.8: OtimizaÃ§Ã£o e Performance]]

---

## âœ… **Checklist de ConclusÃ£o**

- [ ] Compreendeu a arquitetura modular do OTClient
- [ ] Implementou sistema de combate bÃ¡sico
- [ ] Criou sistema de inventÃ¡rio funcional
- [ ] Desenvolveu interface de NPC
- [ ] Integrou mÃºltiplos mÃ³dulos
- [ ] Completou exercÃ­cios prÃ¡ticos
- [ ] Finalizou projeto integrado
- [ ] Revisou documentaÃ§Ã£o tÃ©cnica

---

> [!success] **MÃ³dulo ConcluÃ­do**
> VocÃª agora compreende os sistemas de mÃ³dulos do OTClient e pode implementar funcionalidades de combate, inventÃ¡rio e NPCs usando exemplos reais de cÃ³digo. 